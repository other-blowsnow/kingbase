name: Publish Docker Images

on:
  release:
    types: [published,edited]  # 监听发布事件

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch:
          - amd
          - arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up version
        id: version
        run: |
          # 从 GitHub 事件上下文中提取版本号
          echo "VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          echo "Extracted version: ${{ github.event.release.tag_name }}"
          
      - name: Define Docker image URL
        id: set_url
        run: |
          ARCH=${{ matrix.arch }}
          VERSION=${{ env.VERSION }}
          
          if [ "$ARCH" == "amd" ]; then
            echo "url=https://kingbase.oss-cn-beijing.aliyuncs.com/KESV8R3/05.Docker%E7%89%88%E6%9C%AC/kdb_x86_64_$VERSION.tar" >> $GITHUB_ENV
          elif [ "$ARCH" == "arm" ]; then
            echo "url=https://kingbase.oss-cn-beijing.aliyuncs.com/KESV8R3/05.Docker%E7%89%88%E6%9C%AC/kdb_aarch64_$VERSION.tar" >> $GITHUB_ENV
          fi
      # - name: Cache Docker image tar
      #   uses: actions/cache@v3
      #   with:
      #     path: docker_image.tar
      #     key: ${{ runner.os }}-docker-${{ matrix.arch }}-${{ steps.version.outputs.version }}
          
      - name: Download Docker image tar
        run: |
          if [[ ! -f docker_image.tar ]]; then
            echo "Downloading Docker image: ${env.url}"
            curl -L ${{ env.url }} -o docker_image.tar
          else
            echo "Using cached Docker image."
          fi

      - name: Load Docker image
        run: |
          docker load -i docker_image.tar

      - name: Tag Docker image
        id: tag
        run: |
          VERSION=${{ env.VERSION }}
          IMAGE_ID=$(docker images -q | head -n 1)  # 获取最新构建的镜像 ID
          TAG_NAME="ghcr.io/other-blowsnow/kingbase:${{ matrix.arch }}_${VERSION}"
          echo "Image Tag: $TAG_NAME"
          docker tag $IMAGE_ID $TAG_NAME
          echo "::set-output name=tag::$TAG_NAME"

      - name: Push Docker image
        run: |
          TAG_NAME=${{ steps.tag.outputs.tag }}
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker push $TAG_NAME
